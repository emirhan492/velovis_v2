// 1. Prisma Client
generator client {
  provider = "prisma-client-js"
}

// 2. Veritabanı Bağlantısı
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =================================================================
// ENUM'LAR (Sabit Listeler)
// =================================================================

// Sipariş Durumları
enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
}

// =================================================================
// MODELLER (Tablolar) - DOĞRU SIRAYLA
// =================================================================

// 1. KULLANICI (USER)
// (Diğer her şey buna bağlanır)
model User {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  fullName  String // Trigger ile dolacak
  username  String   @unique
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isActive  Boolean  @default(false)

  // İlişkiler
  comments            ProductComment[]
  refreshTokens       RefreshToken[]
  cartItems           CartItem[]
  orders              Order[]
  passwordResetTokens PasswordResetToken[]
  roles               UserRole[]

  hashedRefreshToken String?

  @@map("users")
}

// 2. KATEGORİ (CATEGORY)
model Category {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // İlişkiler
  products Product[]

  @@map("categories")
}

// 3. ÜRÜN (PRODUCT)
model Product {
  id               String  @id @default(uuid())
  name             String
  slug             String  @unique
  shortDescription String
  longDescription  String
  price            Float
  primaryPhotoUrl  String?
  commentCount     Int     @default(0)
  averageRating    Float   @default(0)
  stockQuantity    Int     @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // İlişkiler
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  photos     ProductPhoto[]
  comments   ProductComment[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@map("products")
}

// 4. ÜRÜN FOTOĞRAFI (PRODUCT_PHOTO)
model ProductPhoto {
  id        String   @id @default(uuid())
  url       String
  size      Int
  isPrimary Boolean  @default(false)
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, order])
  @@map("product_photos")
}

// 5. ÜRÜN YORUMU (PRODUCT_COMMENT)
model ProductComment {
  id      String @id @default(uuid())
  title   String?
  content String?
  rating  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_comments")
}

// 6. YENİLEME TOKEN'I (REFRESH_TOKEN)
model RefreshToken {
  id            String    @id @default(uuid())
  hashedToken   String    @unique
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  invalidatedAt DateTime?

  @@map("refresh_tokens")
}

// 7. SEPET KALEMİ (CART_ITEM)
model CartItem {
  id        String   @id @default(uuid())
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("cart_items")
}

// 8. SİPARİŞ (ORDER)
model Order {
  id         String      @id @default(uuid())
  totalPrice Float
  status     OrderStatus @default(PENDING)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id])

  items OrderItem[]

  @@map("orders")
}

// 9. SİPARİŞ KALEMİ (ORDER_ITEM)
model OrderItem {
  id        String   @id @default(uuid())
  quantity  Int
  unitPrice Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderId String
  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@map("order_items")
}

// 10. ŞİFRE SIFIRLAMA TOKEN'I (PASSWORD_RESET_TOKEN)
model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  userId String
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

// 11. ROL (ROLE)
model Role {
  id    String @id @default(uuid())
  name  String @unique
  
  users       UserRole[]
  permissions RolePermission[]


  @@map("roles")
}

// 12. ROL-YETKİ EŞLEŞMESİ (ROLE_PERMISSION)
model RolePermission {
  roleId         String
  permissionKey  String
  message        String?
  
  role           Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionKey])
  @@map("roles_permissions")
}

// 13. KULLANICI-ROL EŞLEŞMESİ (USER_ROLE)
model UserRole {
  userId String
  roleId String

  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("users_roles")
}